# autoaim
## 1.装甲板检测逻辑
> 此节点接收相机驱动节点发布的图像消息（sensor_msgs::msg::Image），通过cv_bridge库中的API将ros消息转化为Opencv库中的Mat格式，送入网络检测目标装甲板，并为识别到的装甲板分配trakcer，然后从新增装甲板中选出打击车辆ID，检索所有tracker后选出打击装甲板目标，最后发布对应的装甲板消息。
- 网络检测
    > 网络输出的顺序分别为目标的4个角点、装甲板置信度、装甲板的颜色（RED/BLUE/PURPLE/GRAY）、装甲板的类别(8个类别)。
- ~~小陀螺检测~~(详情见`4.小陀螺`)
- 车辆ID选择
    > 该选择逻辑主要存在五层约束：前哨站旋转模式约束/英雄约束/上次目标约束/装甲板旋转角度约束/距离位置约束
    - 1.若进入前哨站旋转装甲模式，检测到前哨站旋转装甲后直接选其ID后退出循环；
    - 2.若检测到危险距离内的英雄直接选其ID后退出循环；
    - 3.若检测到存在上次击打目标、时间较短，且该目标运动较小以及装甲板的旋转角度在某一阈值范围内，则将其选为候选目标，若遍历结束未发现危险距离内的英雄则将其ID选为目标ID；
    - 4.若不存在上次打击目标且装甲板旋转角度在一定阈值范围内，则选为候选目标，若遍历结束未发现危险距离内的英雄则将其ID选为目标ID；
    - 5.若不存在上次打击目标且未检测到危险距离内的英雄目标，则选择当前距离最近，距视野中心较近的目标作为击打目标；
    - 6.若上面四层约束都不满足，则返回当前视野中面积最大的。
- 装甲板选择
    > 该选择逻辑包含三层约束：上次目标tracker约束/目标装甲板面积约束/与图像中心距离约束
    - 1.若上次的trakcer本次仍然存在更新，则直接选择该tracker; 
    - 2.若tracker的当前装甲面积较大，则作为候选tracker； 
    - 3.若tracker的当前面积与目前最大面积相差较小，且距离图像中心较近，则作为候选tracker。

## 2.数据处理
- 弹速处理
    - 考虑到裁判系统反馈的弹速会出现异常值的情况，我们加入条件限制弹速波动，小于10m/s的我们使用上帧弹速，如果弹速波动大于0.5m/s，我们取上帧与当前帧的平均值，小于0.5m/s的波动直接使用当前弹速反馈值。
- 轨迹拟合预测 
    - 预测前考虑对数据误差做处理，首先剔除掉历史队列中的异常值，并通过插值的方式补充，然后再过滤波平滑数据，最后输入模型做预测。
- 小陀螺处理 
    - TODO: 小陀螺状态确定前，存在目标处于小陀螺状态而程序认定为机动状态的误判期，这段时间以机动模型对目标做预测会出现预测点落在车体外边的情况（此时云台会很抖）。尝试对预测结果进行评价反馈处理，即记录从当前预测时刻开始到延时预测时刻内的测量值，与预测值进行误差计算，超过某个阈值或误差累积一定次数即认为预测发散，重新初始化预测。
    - ~~目前对目标小陀螺状态下的旋转周期的求解存在较大的误差，目前的方式是求解目标前后帧的姿态变化，计算出角速度进而得到周期，但由于姿态本身抖动且帧间变化幅度小，误差或大或小。
    FIXME: 目前进一步处理是求多次的目标旋转周期并取平均值，并预先过滤掉周期异常值，即把周期限定在一定范围。~~



## 3.自瞄防抖
> 赛场上相机视野一般是多辆车、多个装甲板同时出现的情况，而目标切换导致的云台来回抖动会对自瞄有较大干扰，因此我们需要加入额外条件限制目标切换。
- ROI \
    锁上目标车辆后，我们只对目标车辆的ROI进行处理可规避掉车辆之间的目标切换。
- Double threshold(双阈值筛选) \
考虑到装甲板在某些角度下置信度会出现跳变从而暂时丢失目标的情况，我们对网络输出的装甲板置信度设置两个阈值，高阈值用于正常检测，当我们锁上目标之后，目标置信度出现跳变且目标在roi范围内，我们使用低阈值筛选roi范围内的装甲板，防止此时切换目标造成云台抖动。
- Spinning constraint（旋转约束）\
目标处于小陀螺状态下会有一段时间两个装甲板同时出现的情况，此时我们加入距离限制防止装甲板出现切换。
## 4.小陀螺
- Detection
![image](docs/spinning_detect_logic.jpg)
    